# ============================================================================
# GitLab CI/CD Templates
# Переиспользуемые шаблоны для jobs
# ============================================================================

# === Общие настройки для всех jobs ===
.common_job:
  tags:
    - shell  # Используем shell runner
  retry:
    max: 1
    when:
      - runner_system_failure
      - stuck_or_timeout_failure

# === Комбинированный шаблон для config_generation ===
.config_generation_template:
  tags:
    - shell
  retry:
    max: 1
    when:
      - runner_system_failure
      - stuck_or_timeout_failure
  before_script:
    # Проверка окружения runner
    - echo "=== Проверка окружения GitLab Runner (shell executor) ==="
    - echo "Runner: ${CI_RUNNER_DESCRIPTION}"
    - echo "Project: ${CI_PROJECT_NAME}"
    - echo "Pipeline ID: ${CI_PIPELINE_ID}"
    - echo "Current User: $(whoami)"
    - echo "Current Directory: $(pwd)"
    - echo ""
    - echo "--- Проверка необходимых утилит ---"
    - which python3 || (echo "ERROR:python3 not found" && exit 1)
    - which jq || (echo "ERROR:jq not found" && exit 1)
    - which ssh || (echo "ERROR:ssh not found" && exit 1)
    - which scp || (echo "ERROR:scp not found" && exit 1)
    - echo "✓ Все необходимые утилиты установлены"
    - echo ""
    # Валидация переменных
    - echo "=== Проверка обязательных переменных ==="
    - |
      ERRORS=0
      if [ -z "$DEPLOY_NODE_HOST" ]; then
        echo "✗ ERROR: Переменная DEPLOY_NODE_HOST не установлена!"
        ERRORS=$((ERRORS+1))
      else
        echo "✓ DEPLOY_NODE_HOST: ${DEPLOY_NODE_HOST}"
      fi
      if [ -z "$SSH_PRIVATE_KEY" ]; then
        echo "✗ ERROR: Переменная SSH_PRIVATE_KEY не установлена!"
        ERRORS=$((ERRORS+1))
      else
        echo "✓ SSH_PRIVATE_KEY: установлен"
      fi
      if [ -z "$CORAX_NODES" ]; then
        echo "✗ ERROR: Переменная CORAX_NODES не установлена!"
        echo "   Пример: [{\"name\":\"node1\",\"host\":\"10.10.11.42\",\"user\":\"root\",\"roles\":[\"kafka\",\"zookeeper\"]}]"
        ERRORS=$((ERRORS+1))
      else
        echo "✓ CORAX_NODES: установлен"
        echo "$CORAX_NODES" | jq empty 2>/dev/null || {
          echo "✗ ERROR: CORAX_NODES содержит некорректный JSON!"
          ERRORS=$((ERRORS+1))
        }
      fi
      if [ $ERRORS -gt 0 ]; then
        echo ""
        echo "Найдено ошибок: $ERRORS"
        echo "Настройте переменные в GitLab: Settings → CI/CD → Variables"
        exit 1
      fi
    - echo "✓ Все обязательные переменные установлены"
    - echo ""
    # Проверка архива
    - echo "=== Проверка наличия архива Corax на runner ==="
    - echo "Директория: ${DISTRIBS_DIR}"
    - echo "Архив: ${CORAX_ARCHIVE}"
    - echo "Полный путь: ${DISTRIBS_DIR}/${CORAX_ARCHIVE}"
    - echo ""
    - |
      if [ ! -d "${DISTRIBS_DIR}" ]; then
        echo "✗ ERROR: Директория ${DISTRIBS_DIR} не существует на runner!"
        echo "Создайте директорию: sudo mkdir -p ${DISTRIBS_DIR}"
        exit 1
      fi
      echo "✓ Директория ${DISTRIBS_DIR} существует"
    - echo ""
    - echo "--- Содержимое ${DISTRIBS_DIR}: ---"
    - ls -lh ${DISTRIBS_DIR}/ || true
    - echo ""
    - |
      if [ ! -f "${DISTRIBS_DIR}/${CORAX_ARCHIVE}" ]; then
        echo "✗ ERROR: Архив ${CORAX_ARCHIVE} не найден в ${DISTRIBS_DIR}!"
        echo ""
        echo "Архив должен содержать структуру проекта Corax:"
        echo "  - ansible.cfg"
        echo "  - playbook.yaml"
        echo "  - files/ (с дистрибутивами и шаблонами)"
        echo "  - group_vars/"
        echo "  - и другие файлы проекта"
        echo ""
        echo "Разместите архив: scp corax_prepare.zip runner-host:${DISTRIBS_DIR}/"
        exit 1
      fi
    - echo "✓ Архив найден: ${CORAX_ARCHIVE}"
    - du -h ${DISTRIBS_DIR}/${CORAX_ARCHIVE}
    - echo ""
    - |
      echo "--- Проверка целостности архива ---"
      if unzip -t ${DISTRIBS_DIR}/${CORAX_ARCHIVE} > /dev/null 2>&1; then
        echo "✓ Архив корректен"
      else
        echo "✗ ERROR: Архив поврежден или имеет неверный формат!"
        exit 1
      fi
    - echo ""
    - |
      echo "--- Содержимое архива (preview): ---"
      unzip -l ${DISTRIBS_DIR}/${CORAX_ARCHIVE} | head -30
    - echo ""
    - echo "✓ Архив Corax готов к использованию"
    - echo ""

# === Комбинированный шаблон для node_preparation ===
.node_preparation_template:
  tags:
    - shell
  retry:
    max: 1
    when:
      - runner_system_failure
      - stuck_or_timeout_failure
  before_script:
    # Проверка окружения runner
    - echo "=== Проверка окружения GitLab Runner (shell executor) ==="
    - echo "Runner: ${CI_RUNNER_DESCRIPTION}"
    - echo "Project: ${CI_PROJECT_NAME}"
    - echo "Pipeline ID: ${CI_PIPELINE_ID}"
    - echo "Current User: $(whoami)"
    - echo "Current Directory: $(pwd)"
    - echo ""
    - echo "--- Проверка необходимых утилит ---"
    - which python3 || (echo "ERROR:python3 not found" && exit 1)
    - which jq || (echo "ERROR:jq not found" && exit 1)
    - which ssh || (echo "ERROR:ssh not found" && exit 1)
    - which scp || (echo "ERROR:scp not found" && exit 1)
    - echo "✓ Все необходимые утилиты установлены"
    - echo ""
    # Валидация переменных
    - echo "=== Проверка обязательных переменных ==="
    - |
      ERRORS=0
      if [ -z "$DEPLOY_NODE_HOST" ]; then
        echo "✗ ERROR: Переменная DEPLOY_NODE_HOST не установлена!"
        ERRORS=$((ERRORS+1))
      else
        echo "✓ DEPLOY_NODE_HOST: ${DEPLOY_NODE_HOST}"
      fi
      if [ -z "$SSH_PRIVATE_KEY" ]; then
        echo "✗ ERROR: Переменная SSH_PRIVATE_KEY не установлена!"
        ERRORS=$((ERRORS+1))
      else
        echo "✓ SSH_PRIVATE_KEY: установлен"
      fi
      if [ -z "$CORAX_NODES" ]; then
        echo "✗ ERROR: Переменная CORAX_NODES не установлена!"
        echo "   Пример: [{\"name\":\"node1\",\"host\":\"10.10.11.42\",\"user\":\"root\",\"roles\":[\"kafka\",\"zookeeper\"]}]"
        ERRORS=$((ERRORS+1))
      else
        echo "✓ CORAX_NODES: установлен"
        echo "$CORAX_NODES" | jq empty 2>/dev/null || {
          echo "✗ ERROR: CORAX_NODES содержит некорректный JSON!"
          ERRORS=$((ERRORS+1))
        }
      fi
      if [ $ERRORS -gt 0 ]; then
        echo ""
        echo "Найдено ошибок: $ERRORS"
        echo "Настройте переменные в GitLab: Settings → CI/CD → Variables"
        exit 1
      fi
    - echo "✓ Все обязательные переменные установлены"
    - echo ""
    # Настройка SSH
    - echo "=== Настройка SSH окружения ==="
    - mkdir -p ~/.ssh
    - chmod 700 ~/.ssh
    - |
      if [ -z "$SSH_PRIVATE_KEY" ]; then
        echo "ERROR: Переменная SSH_PRIVATE_KEY не установлена!"
        exit 1
      fi
    - cp "$SSH_PRIVATE_KEY" ~/.ssh/id_rsa
    - chmod 600 ~/.ssh/id_rsa
    - ssh-keygen -y -f ~/.ssh/id_rsa > ~/.ssh/id_rsa.pub || true
    - echo "✓ SSH ключи настроены"
    - echo ""
