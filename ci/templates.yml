# ============================================================================
# GitLab CI/CD Templates
# Переиспользуемые шаблоны для jobs
# ============================================================================

# === Шаблон для проверки окружения shell runner ===
.check_runner_environment:
  before_script:
    - echo "=== Проверка окружения GitLab Runner (shell executor) ==="
    - echo "Runner: ${CI_RUNNER_DESCRIPTION}"
    - echo "Project: ${CI_PROJECT_NAME}"
    - echo "Pipeline ID: ${CI_PIPELINE_ID}"
    - echo "Current User: $(whoami)"
    - echo "Current Directory: $(pwd)"
    - echo ""
    - echo "--- Проверка необходимых утилит ---"
    - which python3 || (echo "ERROR: python3 not found" && exit 1)
    - which jq || (echo "ERROR: jq not found" && exit 1)
    - which ssh || (echo "ERROR: ssh not found" && exit 1)
    - which scp || (echo "ERROR: scp not found" && exit 1)
    - echo "✓ Все необходимые утилиты установлены"
    - echo ""

# === Шаблон для настройки SSH ===
.setup_ssh:
  before_script:
    - echo "=== Настройка SSH окружения ==="
    - mkdir -p ~/.ssh
    - chmod 700 ~/.ssh
    - |
      if [ -z "$SSH_PRIVATE_KEY" ]; then
        echo "ERROR: Переменная SSH_PRIVATE_KEY не установлена!"
        exit 1
      fi
    - cp "$SSH_PRIVATE_KEY" ~/.ssh/id_rsa
    - chmod 600 ~/.ssh/id_rsa
    - ssh-keygen -y -f ~/.ssh/id_rsa > ~/.ssh/id_rsa.pub || true
    - echo "✓ SSH ключи настроены"
    - echo ""

# === Шаблон для проверки обязательных переменных ===
.validate_required_vars:
  before_script:
    - echo "=== Проверка обязательных переменных ==="
    - |
      ERRORS=0

      if [ -z "$DEPLOY_NODE_HOST" ]; then
        echo "✗ ERROR: Переменная DEPLOY_NODE_HOST не установлена!"
        ERRORS=$((ERRORS+1))
      else
        echo "✓ DEPLOY_NODE_HOST: ${DEPLOY_NODE_HOST}"
      fi

      if [ -z "$SSH_PRIVATE_KEY" ]; then
        echo "✗ ERROR: Переменная SSH_PRIVATE_KEY не установлена!"
        ERRORS=$((ERRORS+1))
      else
        echo "✓ SSH_PRIVATE_KEY: установлен"
      fi

      if [ -z "$CORAX_NODES" ]; then
        echo "✗ ERROR: Переменная CORAX_NODES не установлена!"
        echo "   Пример: [{\"name\":\"node1\",\"host\":\"10.10.11.42\",\"user\":\"root\",\"roles\":[\"kafka\",\"zookeeper\"]}]"
        ERRORS=$((ERRORS+1))
      else
        echo "✓ CORAX_NODES: установлен"
        # Валидация JSON
        echo "$CORAX_NODES" | jq empty 2>/dev/null || {
          echo "✗ ERROR: CORAX_NODES содержит некорректный JSON!"
          ERRORS=$((ERRORS+1))
        }
      fi

      if [ $ERRORS -gt 0 ]; then
        echo ""
        echo "Найдено ошибок: $ERRORS"
        echo "Настройте переменные в GitLab: Settings → CI/CD → Variables"
        exit 1
      fi
    - echo "✓ Все обязательные переменные установлены"
    - echo ""

# === Шаблон для проверки дистрибутивов на runner ===
.check_distribs:
  before_script:
    - echo "=== Проверка наличия дистрибутивов на runner ==="
    - echo "Директория с дистрибутивами: ${DISTRIBS_DIR}"
    - |
      if [ ! -d "${DISTRIBS_DIR}" ]; then
        echo "✗ ERROR: Директория ${DISTRIBS_DIR} не существует на runner!"
        echo "Создайте директорию и поместите туда дистрибутивы Corax"
        exit 1
      fi
    - echo "✓ Директория существует"
    - echo ""
    - echo "--- Содержимое ${DISTRIBS_DIR}: ---"
    - ls -lh ${DISTRIBS_DIR}/ || true
    - echo ""
    - |
      # Проверка наличия необходимых файлов
      REQUIRED_FILES=(
        "KFK-${KFK_VERSION}-distrib.zip"
        "corax-scriptMerger-2.0.0.zip"
        "ansible_corax_json_exporter.zip"
      )

      MISSING_FILES=0
      for FILE in "${REQUIRED_FILES[@]}"; do
        if [ -f "${DISTRIBS_DIR}/${FILE}" ]; then
          echo "✓ Найден: ${FILE} ($(du -h ${DISTRIBS_DIR}/${FILE} | cut -f1))"
        else
          echo "✗ Отсутствует: ${FILE}"
          MISSING_FILES=$((MISSING_FILES+1))
        fi
      done

      if [ $MISSING_FILES -gt 0 ]; then
        echo ""
        echo "WARNING: Не все дистрибутивы найдены (отсутствует: $MISSING_FILES)"
        echo "Убедитесь, что все необходимые файлы размещены в ${DISTRIBS_DIR}/"
      else
        echo ""
        echo "✓ Все необходимые дистрибутивы найдены"
      fi
    - echo ""

# === Общие настройки для всех jobs ===
.common_job:
  tags:
    - shell  # Используем shell runner
  retry:
    max: 1
    when:
      - runner_system_failure
      - stuck_or_timeout_failure
