# ============================================================================
# Job: Node Preparation
# Подготовка деплой ноды для развертывания Corax
# ============================================================================

prepare_deploy_node:
  stage: node_preparation
  extends:
    - .common_job
    - .check_runner_environment
    - .validate_required_vars
    - .setup_ssh
    - .check_distribs

  dependencies:
    - generate_configs

  script:
    - echo "=========================================="
    - echo "ПОДГОТОВКА ДЕПЛОЙ НОДЫ"
    - echo "=========================================="
    - echo ""
    - echo "Деплой нода: ${DEPLOY_NODE_HOST}"
    - echo "Пользователь: ${DEPLOY_NODE_USER}"
    - echo ""

    # === Проверка SSH доступа ===
    - echo "=== Проверка SSH доступа к деплой ноде ==="
    - ssh-keyscan -H ${DEPLOY_NODE_HOST} >> ~/.ssh/known_hosts 2>/dev/null || true
    - |
      if ssh -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no -o ConnectTimeout=10 \
         ${DEPLOY_NODE_USER}@${DEPLOY_NODE_HOST} "echo 'SSH connection successful'"; then
        echo "✓ SSH доступ к деплой ноде установлен"
      else
        echo "✗ ERROR: Не удалось подключиться к деплой ноде ${DEPLOY_NODE_HOST}"
        echo ""
        echo "Проверьте:"
        echo "  1. Корректность IP адреса в переменной DEPLOY_NODE_HOST"
        echo "  2. Корректность SSH ключа в переменной SSH_PRIVATE_KEY"
        echo "  3. Наличие публичного ключа в ~/.ssh/authorized_keys на целевой ноде"
        echo "  4. Доступность ноды по сети (ping, firewall)"
        exit 1
      fi
    - echo ""

    # === Установка пакетов на деплой ноде ===
    - echo "=== Установка необходимых пакетов на деплой ноде ==="
    - |
      ssh -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no \
        ${DEPLOY_NODE_USER}@${DEPLOY_NODE_HOST} bash << 'EOFREMOTE'
      set -e

      echo "--- Проверка версии ОС ---"
      if [ -f /etc/altlinux-release ]; then
        cat /etc/altlinux-release
      else
        echo "WARNING: Это не ALT Linux! Файл /etc/altlinux-release не найден"
        cat /etc/os-release 2>/dev/null || echo "Информация об ОС недоступна"
      fi

      echo ""
      echo "--- Обновление списка пакетов ---"
      apt-get update -q || {
        echo "WARNING: apt-get update завершился с предупреждениями"
      }

      echo ""
      echo "--- Установка базовых пакетов ---"
      # Список пакетов для ALT Linux
      PACKAGES=(
        ansible
        unzip
        sshpass
        java-17-openjdk
        jq
        python3
        python3-module-pip
        git
        curl
        wget
        sudo
        rsync
        tree
      )

      echo "Установка: ${PACKAGES[@]}"
      apt-get install -y "${PACKAGES[@]}" || {
        echo "ERROR: Не удалось установить некоторые пакеты"
        exit 1
      }

      echo ""
      echo "--- Проверка установленных версий ---"
      echo "Ansible: $(ansible --version 2>&1 | head -1)"
      echo "Python: $(python3 --version 2>&1)"
      echo "Java: $(java -version 2>&1 | head -1)"
      echo "JQ: $(jq --version 2>&1)"
      echo "Git: $(git --version 2>&1)"

      echo ""
      echo "✓ Все необходимые пакеты успешно установлены"
      EOFREMOTE

    - echo ""

    # === Создание структуры директорий ===
    - echo "=== Создание структуры директорий на деплой ноде ==="
    - |
      ssh -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no \
        ${DEPLOY_NODE_USER}@${DEPLOY_NODE_HOST} bash << EOFREMOTE
      set -e

      echo "Создание директорий Corax..."
      mkdir -p ${TMP_DIR}
      mkdir -p ${CORAX_DIR}/inventories/group_vars
      mkdir -p ${CORAX_DIR}/playbooks
      mkdir -p ${CORAX_DIR}/roles
      mkdir -p ${CORAX_DIR}/files

      echo ""
      echo "Структура директорий:"
      tree -L 2 ${CORAX_DIR}/ 2>/dev/null || ls -la ${CORAX_DIR}/

      echo ""
      echo "✓ Структура директорий создана"
      EOFREMOTE

    - echo ""

    # === Копирование конфигурационных файлов ===
    - echo "=== Копирование конфигурационных файлов на деплой ноду ==="
    - echo "Источник: ${RUNNER_WORKDIR}"
    - echo "Назначение: ${DEPLOY_NODE_USER}@${DEPLOY_NODE_HOST}:${CORAX_DIR}"
    - echo ""

    # Копирование inventory
    - |
      echo "Копирование inventory.ini..."
      scp -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no \
        ${RUNNER_WORKDIR}/inventories/inventory.ini \
        ${DEPLOY_NODE_USER}@${DEPLOY_NODE_HOST}:${CORAX_DIR}/inventories/inventory.ini
      echo "✓ inventory.ini скопирован"

    # Копирование group_vars
    - |
      echo "Копирование group_vars/all.yaml..."
      scp -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no \
        ${RUNNER_WORKDIR}/inventories/group_vars/all.yaml \
        ${DEPLOY_NODE_USER}@${DEPLOY_NODE_HOST}:${CORAX_DIR}/inventories/group_vars/all.yaml
      echo "✓ group_vars/all.yaml скопирован"

    # Копирование ansible.cfg
    - |
      echo "Копирование ansible.cfg..."
      scp -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no \
        ${RUNNER_WORKDIR}/ansible.cfg \
        ${DEPLOY_NODE_USER}@${DEPLOY_NODE_HOST}:${CORAX_DIR}/ansible.cfg
      echo "✓ ansible.cfg скопирован"

    # Копирование SSH ключа
    - |
      echo "Копирование SSH ключа..."
      scp -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no \
        ${RUNNER_WORKDIR}/ssh_private_key \
        ${DEPLOY_NODE_USER}@${DEPLOY_NODE_HOST}:${CORAX_DIR}/ssh_private_key
      ssh -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no \
        ${DEPLOY_NODE_USER}@${DEPLOY_NODE_HOST} "chmod 600 ${CORAX_DIR}/ssh_private_key"
      echo "✓ SSH ключ скопирован"

    - echo ""

    # === Копирование playbook и файлов проекта ===
    - echo "=== Копирование playbook и вспомогательных файлов ==="
    - |
      echo "Копирование playbook.yaml..."
      scp -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no \
        ${CI_PROJECT_DIR}/playbook.yaml \
        ${DEPLOY_NODE_USER}@${DEPLOY_NODE_HOST}:${CORAX_DIR}/playbook.yaml || {
          echo "WARNING: playbook.yaml не найден в ${CI_PROJECT_DIR}"
        }

    - |
      echo "Копирование вспомогательных файлов из директории files/..."
      scp -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no -r \
        ${CI_PROJECT_DIR}/files/* \
        ${DEPLOY_NODE_USER}@${DEPLOY_NODE_HOST}:${CORAX_DIR}/files/ 2>/dev/null || {
          echo "WARNING: Некоторые файлы из директории files/ не скопированы"
        }

    - echo "✓ Файлы проекта скопированы"
    - echo ""

    # === Копирование дистрибутивов с runner на деплой ноду ===
    - echo "=== Копирование дистрибутивов Corax на деплой ноду ==="
    - echo "Источник: ${DISTRIBS_DIR}"
    - echo "Назначение: ${DEPLOY_NODE_USER}@${DEPLOY_NODE_HOST}:${CORAX_DIR}/files/"
    - echo ""
    - |
      REQUIRED_FILES=(
        "KFK-${KFK_VERSION}-distrib.zip"
        "corax-scriptMerger-2.0.0.zip"
        "ansible_corax_json_exporter.zip"
      )

      for FILE in "${REQUIRED_FILES[@]}"; do
        if [ -f "${DISTRIBS_DIR}/${FILE}" ]; then
          echo "Копирование ${FILE}..."
          scp -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no \
            ${DISTRIBS_DIR}/${FILE} \
            ${DEPLOY_NODE_USER}@${DEPLOY_NODE_HOST}:${CORAX_DIR}/files/${FILE}
          echo "✓ ${FILE} скопирован ($(du -h ${DISTRIBS_DIR}/${FILE} | cut -f1))"
        else
          echo "✗ WARNING: Файл ${FILE} не найден в ${DISTRIBS_DIR}"
        fi
      done

    - echo ""
    - echo "✓ Дистрибутивы скопированы"
    - echo ""

    # === Настройка SSH доступа к рабочим нодам ===
    - echo "=== Настройка SSH доступа к рабочим нодам кластера ==="
    - |
      ssh -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no \
        ${DEPLOY_NODE_USER}@${DEPLOY_NODE_HOST} bash << 'EOFREMOTE'
      set -e

      echo "Настройка SSH ключей..."
      mkdir -p ~/.ssh
      chmod 700 ~/.ssh

      # Копирование SSH ключа в домашнюю директорию пользователя
      cp ${CORAX_DIR}/ssh_private_key ~/.ssh/id_rsa
      chmod 600 ~/.ssh/id_rsa

      # Генерация публичного ключа из приватного
      if [ ! -f ~/.ssh/id_rsa.pub ]; then
        ssh-keygen -y -f ~/.ssh/id_rsa > ~/.ssh/id_rsa.pub
        chmod 644 ~/.ssh/id_rsa.pub
      fi

      echo ""
      echo "=========================================="
      echo "ПУБЛИЧНЫЙ SSH КЛЮЧ ДЛЯ РАБОЧИХ НОД"
      echo "=========================================="
      cat ~/.ssh/id_rsa.pub
      echo "=========================================="
      echo ""
      echo "ВАЖНО: Убедитесь, что этот публичный ключ добавлен в ~/.ssh/authorized_keys"
      echo "       на всех рабочих нодах кластера Corax!"
      echo ""

      # Проверка доступа к нодам из inventory
      echo "--- Проверка доступа к рабочим нодам кластера ---"
      cd ${CORAX_DIR}

      # Извлечение IP адресов из inventory.ini
      NODES=$(grep 'ansible_host=' inventories/inventory.ini | grep -v '^#' | awk '{print $2}' | cut -d= -f2 | sort -u)

      if [ -z "$NODES" ]; then
        echo "WARNING: Не найдено нод в inventory.ini для проверки"
      else
        echo "Найдено уникальных IP адресов: $(echo "$NODES" | wc -l)"
        echo ""

        SUCCESS_COUNT=0
        FAIL_COUNT=0

        for NODE_IP in $NODES; do
          if [ -n "$NODE_IP" ]; then
            echo -n "Проверка $NODE_IP... "
            if timeout 5 ssh -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no -o ConnectTimeout=5 \
               root@$NODE_IP "hostname" 2>/dev/null; then
              echo "✓ OK"
              SUCCESS_COUNT=$((SUCCESS_COUNT+1))
            else
              echo "✗ FAILED"
              FAIL_COUNT=$((FAIL_COUNT+1))
              echo "  WARNING: Не удалось подключиться к ноде $NODE_IP"
              echo "  Убедитесь, что:"
              echo "    - Нода доступна по сети"
              echo "    - Публичный ключ добавлен в ~/.ssh/authorized_keys"
              echo "    - SSH сервис запущен на ноде"
            fi
          fi
        done

        echo ""
        echo "Результат проверки: успешно $SUCCESS_COUNT, ошибок $FAIL_COUNT"

        if [ $FAIL_COUNT -gt 0 ]; then
          echo ""
          echo "WARNING: Обнаружены недоступные ноды!"
          echo "Настройте SSH доступ перед запуском Ansible playbooks"
        fi
      fi

      echo ""
      echo "✓ SSH настроен"
      EOFREMOTE

    - echo ""

    # === Проверка готовности окружения для Ansible ===
    - echo "=== Проверка готовности окружения для Ansible ==="
    - |
      ssh -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no \
        ${DEPLOY_NODE_USER}@${DEPLOY_NODE_HOST} bash << 'EOFREMOTE'
      set -e
      cd ${CORAX_DIR}

      echo "--- Структура проекта Corax ---"
      tree -L 3 . 2>/dev/null || ls -laR | head -50

      echo ""
      echo "--- Содержимое директории files ---"
      ls -lh files/ 2>/dev/null || echo "Директория files/ пуста"

      echo ""
      echo "--- Проверка Ansible конфигурации ---"
      export ANSIBLE_CONFIG=${CORAX_DIR}/ansible.cfg
      ansible --version

      echo ""
      echo "--- Тестовый запуск Ansible ping ---"
      ansible all -i inventories/inventory.ini -m ping || {
        echo ""
        echo "WARNING: Ansible ping не прошел успешно"
        echo "Это ожидаемо, если SSH ключи еще не распространены на рабочие ноды"
        echo "Или если рабочие ноды еще не готовы"
      }

      echo ""
      echo "✓ Окружение подготовлено для запуска Ansible playbooks"
      EOFREMOTE

    - echo ""

    # === Итоговая информация ===
    - echo "=========================================="
    - echo "ПОДГОТОВКА ДЕПЛОЙ НОДЫ ЗАВЕРШЕНА"
    - echo "=========================================="
    - echo ""
    - echo "Следующие шаги для развертывания Corax:"
    - echo ""
    - echo "1. Подключитесь к деплой ноде:"
    - echo "   ssh ${DEPLOY_NODE_USER}@${DEPLOY_NODE_HOST}"
    - echo ""
    - echo "2. Перейдите в директорию Corax:"
    - echo "   cd ${CORAX_DIR}"
    - echo ""
    - echo "3. Убедитесь, что SSH ключи настроены на всех рабочих нодах"
    - echo "   (см. публичный ключ в выводе выше)"
    - echo ""
    - echo "4. Запустите playbook для подготовки дистрибутивов:"
    - echo "   ansible-playbook -i inventories/inventory.ini playbook.yaml"
    - echo ""
    - echo "5. Запустите развертывание компонентов Corax:"
    - echo "   ansible-playbook -i inventories/inventory.ini prepare_corax.yaml"
    - echo "   ansible-playbook -i inventories/inventory.ini playbooks/kafka-zookeeper-SE.yml -t enabled_service"
    - echo "   ansible-playbook -i inventories/inventory.ini playbooks/kafka-zookeeper-SE.yml"
    - echo "   ansible-playbook -i inventories/inventory.ini playbooks/crxsr.yml -t root,install,start"
    - echo "   ansible-playbook -i inventories/inventory.ini playbooks/crxui.yml -t root,install"
    - echo "   ansible-playbook -i inventories/inventory.ini post_install_corax.yaml"
    - echo ""
    - echo "=========================================="
    - echo ""

  when: manual  # Требует ручного подтверждения для безопасности

  only:
    - branches
