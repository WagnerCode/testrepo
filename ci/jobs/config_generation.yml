# ============================================================================
# Job: Config Generation
# Распаковка архива Corax и генерация конфигурационных файлов
# ============================================================================

generate_configs:
  stage: config_generation
  extends:
    - .common_job
    - .check_runner_environment
    - .validate_required_vars
    - .check_corax_archive

  script:
    - echo "=========================================="
    - echo "ПОДГОТОВКА СТРУКТУРЫ CORAX"
    - echo "=========================================="
    - echo ""

    # Очистка и создание рабочей директории
    - echo "=== Подготовка рабочей директории ==="
    - rm -rf ${RUNNER_WORKDIR}
    - mkdir -p ${RUNNER_WORKDIR}
    - echo "✓ Рабочая директория создана: ${RUNNER_WORKDIR}"
    - echo ""

    # Распаковка архива Corax
    - echo "=== Распаковка архива ${CORAX_ARCHIVE} ==="
    - |
      cd ${RUNNER_WORKDIR}
      unzip -q ${DISTRIBS_DIR}/${CORAX_ARCHIVE}
      echo "✓ Архив распакован"
    - echo ""
    - echo "--- Структура распакованного архива: ---"
    - tree -L 2 ${RUNNER_WORKDIR} || ls -laR ${RUNNER_WORKDIR} | head -50
    - echo ""

    # Создание Python скрипта для генерации inventory
    - echo "=== Создание генератора inventory.ini ==="
    - mkdir -p ${RUNNER_WORKDIR}/scripts
    - |
      cat > ${RUNNER_WORKDIR}/scripts/generate_inventory.py << 'EOFPY'
      #!/usr/bin/env python3
      """
      Генератор inventory.ini из JSON конфигурации нод
      """
      import json
      import os
      import sys

      def generate_inventory(nodes_json, ansible_user):
          """Генерация inventory.ini из JSON списка нод"""
          try:
              nodes = json.loads(nodes_json)
          except json.JSONDecodeError as e:
              print(f"ERROR: Некорректный JSON в CORAX_NODES: {e}", file=sys.stderr)
              sys.exit(1)

          if not isinstance(nodes, list):
              print("ERROR: CORAX_NODES должен быть JSON массивом", file=sys.stderr)
              sys.exit(1)

          # Структура для хранения хостов по ролям
          roles_hosts = {
              'kafka': [],
              'zookeeper': [],
              'crxsr': [],
              'crxui': []
          }

          # Заполнение ролей
          for node in nodes:
              name = node.get('name', 'unknown')
              host = node.get('host', '')
              user = node.get('user', ansible_user)
              roles = node.get('roles', [])

              if not host:
                  print(f"WARNING: Нода {name} не имеет IP адреса", file=sys.stderr)
                  continue

              host_line = f"{name}       ansible_host={host}         ansible_user={user}"

              for role in roles:
                  if role in roles_hosts:
                      roles_hosts[role].append(host_line)
                  else:
                      print(f"WARNING: Неизвестная роль '{role}' для ноды {name}", file=sys.stderr)

          # Генерация inventory
          inventory_content = []
          for role in ['kafka', 'zookeeper', 'crxsr', 'crxui']:
              inventory_content.append(f"[{role}]")
              if roles_hosts[role]:
                  for host in roles_hosts[role]:
                      inventory_content.append(host)
              else:
                  inventory_content.append(f"# No hosts defined for {role} role")
              inventory_content.append("")

          return "\n".join(inventory_content)

      if __name__ == "__main__":
          nodes_json = os.environ.get('CORAX_NODES', '[]')
          ansible_user = os.environ.get('ANSIBLE_USER', 'user1')

          print("=== Генерация inventory.ini ===", file=sys.stderr)
          print(f"Ansible user: {ansible_user}", file=sys.stderr)

          inventory = generate_inventory(nodes_json, ansible_user)

          # Подсчет нод
          nodes = json.loads(nodes_json)
          print(f"Обработано нод: {len(nodes)}", file=sys.stderr)

          print(inventory)
      EOFPY

    - chmod +x ${RUNNER_WORKDIR}/scripts/generate_inventory.py
    - echo "✓ Генератор inventory создан"
    - echo ""

    # Генерация inventory.ini
    - echo "=== Генерация inventory.ini ==="
    - python3 ${RUNNER_WORKDIR}/scripts/generate_inventory.py > ${RUNNER_WORKDIR}/inventory.ini
    - echo ""
    - echo "--- Сгенерированный inventory.ini: ---"
    - cat ${RUNNER_WORKDIR}/inventory.ini
    - echo ""
    - echo "✓ Файл inventory.ini сгенерирован и заменен в структуре"
    - echo ""

    # Генерация group_vars/all.yaml
    - echo "=== Генерация group_vars/all.yaml ==="
    - |
      cat > ${RUNNER_WORKDIR}/group_vars/all.yaml << EOFYAML
      # ============================================================================
      # Corax Cluster Configuration
      # Сгенерировано автоматически GitLab CI/CD Pipeline ${CI_PIPELINE_ID}
      # Дата: $(date -Iseconds)
      # ============================================================================

      # Временные директории
      tmp_dir: /tmp/installer

      # Параметры запуска
      wait_for_start: 20
      customJavaPath: false

      # Настройки безопасности
      security: PLAINTEXT__ZK_PLAIN_NO_AUTH__KAFKA_PLAINTEXT_NO_AUTH

      # Пользователи и группы
      kafka_user: kafka
      kafka_group: kafka
      zookeeper_user: kafka
      zookeeper_group: kafka

      # Настройки сервисов
      enabled_service: true

      # ============================================================================
      # Kafka Configuration
      # ============================================================================
      kafka:
        distr: distrib.zip
        installdir: ${KAFKA_INSTALL_DIR}
        logdir: ${KAFKA_INSTALL_DIR}/logs
        datadir: ${KAFKA_DATA_DIR}
        cleanLog: false
        cleanData: false

      # ============================================================================
      # Zookeeper Configuration
      # ============================================================================
      zookeeper:
        distr: distrib.zip
        installdir: ${KAFKA_INSTALL_DIR}
        logdir: ${KAFKA_INSTALL_DIR}/logs
        datadir: ${ZOOKEEPER_DATA_DIR}
        cleanLog: false
        cleanData: false

      # ============================================================================
      # Corax Schema Registry Configuration
      # ============================================================================
      crxsr:
        distr: distrib.zip
        installdir: ${KAFKA_INSTALL_DIR}
        cleanLog: false
        prop_var:
          "server_port": ${CRXSR_PORT}

      # ============================================================================
      # Corax UI Configuration
      # ============================================================================
      crxui:
        distr: distrib.zip
        installdir: ${KAFKA_INSTALL_DIR}
        cleanLog: false
        cleanData: false
        server.port: ${CRXUI_PORT}
      EOFYAML

    - echo "✓ Файл group_vars/all.yaml сгенерирован и заменен в структуре"
    - echo ""
    - echo "--- Сгенерированный group_vars/all.yaml: ---"
    - cat ${RUNNER_WORKDIR}/group_vars/all.yaml
    - echo ""

    # Копирование SSH ключа
    - echo "=== Подготовка SSH ключа ==="
    - cp "$SSH_PRIVATE_KEY" ${RUNNER_WORKDIR}/ssh_private_key
    - chmod 600 ${RUNNER_WORKDIR}/ssh_private_key
    - echo "✓ SSH ключ добавлен в структуру"
    - echo ""

    # Обновление ansible.cfg
    - echo "=== Обновление ansible.cfg ==="
    - |
      cat > ${RUNNER_WORKDIR}/ansible.cfg << EOFCFG
      [defaults]
      roles_path = ./roles
      host_key_checking = False
      remote_user = ${ANSIBLE_USER}
      private_key_file = ./ssh_private_key
      stdout_callback = ${ANSIBLE_STDOUT_CALLBACK}
      force_color = ${ANSIBLE_FORCE_COLOR}

      [inventory]
      enable_plugins = script, ini, yaml

      [ssh_connection]
      pipelining = True
      ssh_args = -o ControlMaster=auto -o ControlPersist=60s
      EOFCFG

    - echo "✓ Файл ansible.cfg обновлен"
    - cat ${RUNNER_WORKDIR}/ansible.cfg
    - echo ""

    # Создание манифеста конфигурации
    - echo "=== Создание манифеста конфигурации ==="
    - |
      cat > ${RUNNER_WORKDIR}/config_manifest.json << EOFJSON
      {
        "generated_at": "$(date -Iseconds)",
        "pipeline_id": "${CI_PIPELINE_ID}",
        "pipeline_url": "${CI_PIPELINE_URL}",
        "commit_sha": "${CI_COMMIT_SHA}",
        "commit_ref": "${CI_COMMIT_REF_NAME}",
        "runner_description": "${CI_RUNNER_DESCRIPTION}",
        "source_archive": "${CORAX_ARCHIVE}",
        "deploy_node_host": "${DEPLOY_NODE_HOST}",
        "deploy_node_user": "${DEPLOY_NODE_USER}",
        "ansible_user": "${ANSIBLE_USER}",
        "kfk_version": "${KFK_VERSION}",
        "corax_dir": "${CORAX_DIR}",
        "kafka_install_dir": "${KAFKA_INSTALL_DIR}",
        "kafka_data_dir": "${KAFKA_DATA_DIR}",
        "zookeeper_data_dir": "${ZOOKEEPER_DATA_DIR}",
        "crxui_port": ${CRXUI_PORT},
        "crxsr_port": ${CRXSR_PORT}
      }
      EOFJSON

    - echo "✓ Манифест создан"
    - echo ""
    - echo "--- Манифест конфигурации: ---"
    - cat ${RUNNER_WORKDIR}/config_manifest.json | jq .
    - echo ""

    # Проверка содержимого дистрибутивов в архиве
    - echo "=== Проверка дистрибутивов в директории files/ ==="
    - ls -lh ${RUNNER_WORKDIR}/files/ || echo "WARNING: Директория files/ не найдена"
    - echo ""

    # Финальная структура
    - echo "=========================================="
    - echo "ПОДГОТОВКА ЗАВЕРШЕНА"
    - echo "=========================================="
    - echo ""
    - echo "Итоговая структура Corax:"
    - tree -L 2 ${RUNNER_WORKDIR} || ls -la ${RUNNER_WORKDIR}
    - echo ""
    - echo "✓ Структура Corax подготовлена и готова к развертыванию"
    - echo ""

  artifacts:
    name: "corax-prepared-${CI_PIPELINE_ID}"
    paths:
      - ${RUNNER_WORKDIR}/
    expire_in: 1 week

  only:
    - branches
