# GitLab CI/CD Pipeline для деплоя кластера Corax на ALT Linux 10.2
#
# Требуемые переменные GitLab CI/CD:
# - DEPLOY_NODE_HOST: IP адрес деплой ноды (например: 10.10.11.41)
# - DEPLOY_NODE_USER: Пользователь для деплой ноды (по умолчанию: root)
# - SSH_PRIVATE_KEY: Приватный SSH ключ для подключения к нодам (type: File)
# - CORAX_NODES: JSON список нод кластера Corax (например: [{"name":"vm-node1","host":"10.10.11.42","user":"root","roles":["kafka","zookeeper"]},{"name":"vm-node2","host":"10.10.11.43","user":"root","roles":["kafka","zookeeper","crxsr","crxui"]}])
#
# Опциональные переменные:
# - KAFKA_INSTALL_DIR: Путь установки Kafka (по умолчанию: /pub/opt/Apache/kafka)
# - KAFKA_DATA_DIR: Путь для данных Kafka (по умолчанию: /pub/KAFKADATA)
# - ZOOKEEPER_DATA_DIR: Путь для данных Zookeeper (по умолчанию: /pub/zookeeper)
# - CRXUI_PORT: Порт для CRXUI (по умолчанию: 9090)
# - CRXSR_PORT: Порт для CRXSR (по умолчанию: 8081)
# - KFK_VERSION: Версия дистрибутива KFK (по умолчанию: 11.340.0-16)
# - ANSIBLE_USER: Пользователь для ansible (по умолчанию: user1)

stages:
  - config_generation
  - node_preparation

variables:
  # Переменные по умолчанию
  DEPLOY_NODE_USER: "root"
  ANSIBLE_USER: "user1"
  KAFKA_INSTALL_DIR: "/pub/opt/Apache/kafka"
  KAFKA_DATA_DIR: "/pub/KAFKADATA"
  ZOOKEEPER_DATA_DIR: "/pub/zookeeper"
  CRXUI_PORT: "9090"
  CRXSR_PORT: "8081"
  KFK_VERSION: "11.340.0-16"
  CORAX_DIR: "/pub/corax"
  TMP_DIR: "/pub/corax/tmp"

  # Ansible настройки
  ANSIBLE_HOST_KEY_CHECKING: "False"
  ANSIBLE_FORCE_COLOR: "True"

# ============================================================================
# STAGE: config_generation
# Генерация конфигурационных файлов для кластера Corax
# ============================================================================

generate_configs:
  stage: config_generation
  image: python:3.11-slim
  before_script:
    - apt-get update && apt-get install -y jq gettext-base
    - pip install jinja2 pyyaml
  script:
    - echo "=== Генерация конфигурационных файлов из шаблонов ==="

    # Создание директорий для конфигов
    - mkdir -p generated_configs/inventories/group_vars
    - mkdir -p generated_configs/scripts

    # Проверка обязательных переменных
    - |
      if [ -z "$DEPLOY_NODE_HOST" ]; then
        echo "ERROR: Переменная DEPLOY_NODE_HOST не установлена!"
        exit 1
      fi
    - |
      if [ -z "$SSH_PRIVATE_KEY" ]; then
        echo "ERROR: Переменная SSH_PRIVATE_KEY не установлена!"
        exit 1
      fi
    - |
      if [ -z "$CORAX_NODES" ]; then
        echo "ERROR: Переменная CORAX_NODES не установлена!"
        echo "Пример значения: [{\"name\":\"vm-node1\",\"host\":\"10.10.11.42\",\"user\":\"root\",\"roles\":[\"kafka\",\"zookeeper\"]}]"
        exit 1
      fi

    # Создание Python скрипта для генерации inventory.ini из JSON
    - |
      cat > generate_inventory.py << 'EOFPY'
      #!/usr/bin/env python3
      import json
      import os
      import sys

      def generate_inventory(nodes_json, ansible_user):
          """Генерация inventory.ini из JSON списка нод"""
          try:
              nodes = json.loads(nodes_json)
          except json.JSONDecodeError as e:
              print(f"ERROR: Некорректный JSON в CORAX_NODES: {e}", file=sys.stderr)
              sys.exit(1)

          # Структура для хранения хостов по ролям
          roles_hosts = {
              'kafka': [],
              'zookeeper': [],
              'crxsr': [],
              'crxui': []
          }

          # Заполнение ролей
          for node in nodes:
              name = node.get('name', 'unknown')
              host = node.get('host', '')
              user = node.get('user', ansible_user)
              roles = node.get('roles', [])

              host_line = f"{name}       ansible_host={host}         ansible_user={user}"

              for role in roles:
                  if role in roles_hosts:
                      roles_hosts[role].append(host_line)

          # Генерация inventory
          inventory_content = []
          for role, hosts in roles_hosts.items():
              inventory_content.append(f"[{role}]")
              if hosts:
                  for host in hosts:
                      inventory_content.append(host)
              else:
                  inventory_content.append("# No hosts defined for this role")
              inventory_content.append("")

          return "\n".join(inventory_content)

      if __name__ == "__main__":
          nodes_json = os.environ.get('CORAX_NODES', '[]')
          ansible_user = os.environ.get('ANSIBLE_USER', 'user1')

          inventory = generate_inventory(nodes_json, ansible_user)
          print(inventory)
      EOFPY

    - chmod +x generate_inventory.py
    - python3 generate_inventory.py > generated_configs/inventories/inventory.ini

    - echo "=== Сгенерированный inventory.ini ==="
    - cat generated_configs/inventories/inventory.ini

    # Генерация group_vars/all.yaml с подстановкой переменных
    - |
      cat > generated_configs/inventories/group_vars/all.yaml << EOFYAML
      tmp_dir: /tmp/installer
      wait_for_start: 20
      customJavaPath: false
      security: PLAINTEXT__ZK_PLAIN_NO_AUTH__KAFKA_PLAINTEXT_NO_AUTH
      kafka_user: kafka
      kafka_group: kafka
      zookeeper_user: kafka
      zookeeper_group: kafka
      enabled_service: true

      kafka:
          distr: distrib.zip
          installdir: ${KAFKA_INSTALL_DIR}
          logdir: ${KAFKA_INSTALL_DIR}/logs
          datadir: ${KAFKA_DATA_DIR}
          cleanLog: false
          cleanData: false

      zookeeper:
          distr: distrib.zip
          installdir: ${KAFKA_INSTALL_DIR}
          logdir: ${KAFKA_INSTALL_DIR}/logs
          datadir: ${ZOOKEEPER_DATA_DIR}
          cleanLog: false
          cleanData: false

      crxsr:
        distr: distrib.zip
        installdir: ${KAFKA_INSTALL_DIR}
        cleanLog: false
        prop_var:
          "server_port": ${CRXSR_PORT}

      crxui:
          distr: distrib.zip
          installdir: ${KAFKA_INSTALL_DIR}
          cleanLog: false
          cleanData: false
          server.port: ${CRXUI_PORT}
      EOFYAML

    - echo "=== Сгенерированный group_vars/all.yaml ==="
    - cat generated_configs/inventories/group_vars/all.yaml

    # Генерация inventory.ini для начального деплоя (bootstrap)
    - |
      cat > generated_configs/inventory_bootstrap.ini << EOFINV
      # Inventory для начальной подготовки деплой ноды
      [deploy_node]
      deploy-node ansible_host=${DEPLOY_NODE_HOST} ansible_user=${DEPLOY_NODE_USER}
      EOFINV

    - echo "=== Сгенерированный inventory_bootstrap.ini ==="
    - cat generated_configs/inventory_bootstrap.ini

    # Копирование SSH ключа
    - cp "$SSH_PRIVATE_KEY" generated_configs/ssh_private_key
    - chmod 600 generated_configs/ssh_private_key

    # Создание ansible.cfg
    - |
      cat > generated_configs/ansible.cfg << EOFCFG
      [defaults]
      roles_path = ./roles
      host_key_checking = False
      remote_user = ${ANSIBLE_USER}
      private_key_file = ./ssh_private_key

      [inventory]
      enable_plugins = script, ini, yaml
      EOFCFG

    - echo "=== Сгенерированный ansible.cfg ==="
    - cat generated_configs/ansible.cfg

    # Создание манифеста конфигурации для отладки
    - |
      cat > generated_configs/config_manifest.json << EOFJSON
      {
        "generated_at": "$(date -Iseconds)",
        "pipeline_id": "${CI_PIPELINE_ID}",
        "commit_sha": "${CI_COMMIT_SHA}",
        "deploy_node_host": "${DEPLOY_NODE_HOST}",
        "deploy_node_user": "${DEPLOY_NODE_USER}",
        "ansible_user": "${ANSIBLE_USER}",
        "kfk_version": "${KFK_VERSION}",
        "corax_dir": "${CORAX_DIR}",
        "kafka_install_dir": "${KAFKA_INSTALL_DIR}",
        "kafka_data_dir": "${KAFKA_DATA_DIR}",
        "zookeeper_data_dir": "${ZOOKEEPER_DATA_DIR}",
        "crxui_port": ${CRXUI_PORT},
        "crxsr_port": ${CRXSR_PORT}
      }
      EOFJSON

    - echo "=== Манифест конфигурации ==="
    - cat generated_configs/config_manifest.json

    - echo "=== Генерация конфигов завершена успешно ==="

  artifacts:
    name: "corax-configs-${CI_PIPELINE_ID}"
    paths:
      - generated_configs/
    expire_in: 1 week
    reports:
      dotenv: generated_configs/config_manifest.json

  tags:
    - docker

# ============================================================================
# STAGE: node_preparation
# Подготовка деплой ноды для развертывания Corax
# ============================================================================

prepare_deploy_node:
  stage: node_preparation
  image: alpine:latest
  dependencies:
    - generate_configs
  before_script:
    # Установка необходимых утилит в Alpine для SSH
    - apk add --no-cache openssh-client sshpass bash
  script:
    - echo "=== Подготовка деплой ноды ${DEPLOY_NODE_HOST} ==="

    # Настройка SSH
    - mkdir -p ~/.ssh
    - cp generated_configs/ssh_private_key ~/.ssh/id_rsa
    - chmod 600 ~/.ssh/id_rsa
    - ssh-keyscan -H ${DEPLOY_NODE_HOST} >> ~/.ssh/known_hosts 2>/dev/null || true

    # Проверка доступности деплой ноды
    - |
      echo "=== Проверка SSH доступа к деплой ноде ==="
      if ssh -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no -o ConnectTimeout=10 ${DEPLOY_NODE_USER}@${DEPLOY_NODE_HOST} "echo 'SSH connection successful'"; then
        echo "✓ SSH доступ к деплой ноде установлен"
      else
        echo "✗ ERROR: Не удалось подключиться к деплой ноде ${DEPLOY_NODE_HOST}"
        echo "Проверьте:"
        echo "  1. Корректность IP адреса в переменной DEPLOY_NODE_HOST"
        echo "  2. Корректность SSH ключа в переменной SSH_PRIVATE_KEY"
        echo "  3. Наличие публичного ключа в ~/.ssh/authorized_keys на целевой ноде"
        echo "  4. Доступность ноды по сети"
        exit 1
      fi

    # Установка необходимых пакетов на ALT Linux
    - |
      echo "=== Установка необходимых пакетов на ALT Linux 10.2 ==="
      ssh -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no ${DEPLOY_NODE_USER}@${DEPLOY_NODE_HOST} bash << 'EOFREMOTE'
      set -e

      echo "--- Проверка версии ОС ---"
      if [ -f /etc/altlinux-release ]; then
        cat /etc/altlinux-release
      else
        echo "WARNING: Это не ALT Linux! Файл /etc/altlinux-release не найден"
        cat /etc/os-release || true
      fi

      echo ""
      echo "--- Обновление списка пакетов ---"
      apt-get update || {
        echo "WARNING: apt-get update завершился с ошибкой, пытаемся продолжить..."
      }

      echo ""
      echo "--- Установка базовых пакетов ---"
      # Установка базовых инструментов
      apt-get install -y \
        ansible \
        unzip \
        sshpass \
        openjdk-17-jdk \
        jq \
        python3 \
        python3-module-pip \
        git \
        curl \
        wget \
        sudo || {
          echo "ERROR: Не удалось установить необходимые пакеты"
          exit 1
        }

      echo ""
      echo "--- Проверка установленных версий ---"
      ansible --version | head -1
      unzip -v | head -1
      java -version 2>&1 | head -1
      jq --version
      python3 --version

      echo ""
      echo "✓ Все необходимые пакеты успешно установлены"
      EOFREMOTE

    # Создание структуры директорий
    - |
      echo "=== Создание структуры директорий на деплой ноде ==="
      ssh -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no ${DEPLOY_NODE_USER}@${DEPLOY_NODE_HOST} bash << EOFREMOTE
      set -e

      echo "--- Создание директорий Corax ---"
      mkdir -p ${TMP_DIR}
      mkdir -p ${CORAX_DIR}/inventories/group_vars
      mkdir -p ${CORAX_DIR}/playbooks
      mkdir -p ${CORAX_DIR}/roles
      mkdir -p ${CORAX_DIR}/files

      echo "✓ Структура директорий создана:"
      ls -la ${CORAX_DIR}/
      EOFREMOTE

    # Копирование конфигурационных файлов на деплой ноду
    - |
      echo "=== Копирование сгенерированных конфигов на деплой ноду ==="
      scp -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no \
        generated_configs/inventories/inventory.ini \
        ${DEPLOY_NODE_USER}@${DEPLOY_NODE_HOST}:${CORAX_DIR}/inventories/inventory.ini

      scp -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no \
        generated_configs/inventories/group_vars/all.yaml \
        ${DEPLOY_NODE_USER}@${DEPLOY_NODE_HOST}:${CORAX_DIR}/inventories/group_vars/all.yaml

      scp -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no \
        generated_configs/ansible.cfg \
        ${DEPLOY_NODE_USER}@${DEPLOY_NODE_HOST}:${CORAX_DIR}/ansible.cfg

      scp -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no \
        generated_configs/ssh_private_key \
        ${DEPLOY_NODE_USER}@${DEPLOY_NODE_HOST}:${CORAX_DIR}/ssh_private_key

      echo "✓ Конфигурационные файлы скопированы"

    # Копирование playbook и файлов проекта
    - |
      echo "=== Копирование playbook и вспомогательных файлов ==="
      scp -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no -r \
        playbook.yaml \
        ${DEPLOY_NODE_USER}@${DEPLOY_NODE_HOST}:${CORAX_DIR}/

      scp -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no -r \
        files/* \
        ${DEPLOY_NODE_USER}@${DEPLOY_NODE_HOST}:${CORAX_DIR}/files/ || true

      echo "✓ Файлы проекта скопированы"

    # Настройка SSH доступа от деплой ноды к рабочим нодам
    - |
      echo "=== Настройка SSH доступа к рабочим нодам кластера ==="
      ssh -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no ${DEPLOY_NODE_USER}@${DEPLOY_NODE_HOST} bash << 'EOFREMOTE'
      set -e

      # Копирование SSH ключа в домашнюю директорию пользователя
      mkdir -p ~/.ssh
      cp ${CORAX_DIR}/ssh_private_key ~/.ssh/id_rsa
      chmod 600 ~/.ssh/id_rsa

      # Генерация публичного ключа из приватного, если его нет
      if [ ! -f ~/.ssh/id_rsa.pub ]; then
        ssh-keygen -y -f ~/.ssh/id_rsa > ~/.ssh/id_rsa.pub
      fi

      echo ""
      echo "--- Публичный SSH ключ для распространения на рабочие ноды: ---"
      cat ~/.ssh/id_rsa.pub
      echo ""
      echo "ВАЖНО: Убедитесь, что этот публичный ключ добавлен в ~/.ssh/authorized_keys"
      echo "       на всех рабочих нодах кластера!"
      echo ""

      # Проверка доступа к нодам из inventory
      echo "--- Проверка доступа к нодам кластера ---"
      cd ${CORAX_DIR}

      # Извлечение IP адресов из inventory.ini
      NODES=$(grep 'ansible_host=' inventories/inventory.ini | grep -v '^#' | awk '{print $2}' | cut -d= -f2 | sort -u)

      if [ -z "$NODES" ]; then
        echo "WARNING: Не найдено нод в inventory.ini для проверки"
      else
        for NODE_IP in $NODES; do
          if [ -n "$NODE_IP" ]; then
            echo -n "Проверка доступа к $NODE_IP... "
            if timeout 5 ssh -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no -o ConnectTimeout=5 root@$NODE_IP "echo 'OK'" 2>/dev/null; then
              echo "✓ OK"
            else
              echo "✗ FAILED"
              echo "WARNING: Не удалось подключиться к ноде $NODE_IP"
              echo "Убедитесь, что:"
              echo "  1. Нода доступна по сети"
              echo "  2. Публичный ключ добавлен в ~/.ssh/authorized_keys"
              echo "  3. SSH сервис запущен на ноде"
            fi
          fi
        done
      fi

      echo ""
      echo "✓ SSH настроен"
      EOFREMOTE

    # Проверка готовности окружения для Ansible
    - |
      echo "=== Проверка готовности окружения для запуска Ansible ==="
      ssh -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no ${DEPLOY_NODE_USER}@${DEPLOY_NODE_HOST} bash << 'EOFREMOTE'
      set -e
      cd ${CORAX_DIR}

      echo "--- Структура проекта ---"
      tree -L 2 . || ls -laR

      echo ""
      echo "--- Проверка Ansible конфигурации ---"
      export ANSIBLE_CONFIG=${CORAX_DIR}/ansible.cfg
      ansible --version

      echo ""
      echo "--- Тестовый запуск Ansible ping ---"
      # Попытка пинга нод (может не сработать, если SSH ключи не настроены на рабочих нодах)
      ansible all -i inventories/inventory.ini -m ping || {
        echo "WARNING: Ansible ping не прошел успешно"
        echo "Это ожидаемо, если SSH ключи еще не распространены на рабочие ноды"
      }

      echo ""
      echo "✓ Окружение подготовлено для запуска Ansible playbooks"
      EOFREMOTE

    - echo "=== Подготовка деплой ноды завершена успешно ==="
    - echo ""
    - echo "==========================================="
    - echo "СЛЕДУЮЩИЕ ШАГИ ДЛЯ РАЗВЕРТЫВАНИЯ CORAX:"
    - echo "==========================================="
    - echo "1. Убедитесь, что публичный SSH ключ (см. вывод выше) добавлен на все рабочие ноды в ~/.ssh/authorized_keys"
    - echo "2. Убедитесь, что дистрибутивы Corax размещены в ${CORAX_DIR}/files/"
    - echo "   Необходимые файлы:"
    - echo "   - KFK-${KFK_VERSION}-distrib.zip"
    - echo "   - corax-scriptMerger-2.0.0.zip"
    - echo "   - ansible_corax_json_exporter.zip"
    - echo "3. Подключитесь к деплой ноде:"
    - echo "   ssh ${DEPLOY_NODE_USER}@${DEPLOY_NODE_HOST}"
    - echo "4. Перейдите в директорию Corax:"
    - echo "   cd ${CORAX_DIR}"
    - echo "5. Запустите playbook для подготовки:"
    - echo "   ansible-playbook -i inventories/inventory.ini playbook.yaml"
    - echo "6. После успешной подготовки запустите развертывание Corax:"
    - echo "   ansible-playbook -i inventories/inventory.ini prepare_corax.yaml"
    - echo "   ansible-playbook -i inventories/inventory.ini playbooks/kafka-zookeeper-SE.yml -t enabled_service"
    - echo "   ansible-playbook -i inventories/inventory.ini playbooks/kafka-zookeeper-SE.yml"
    - echo "   ansible-playbook -i inventories/inventory.ini playbooks/crxsr.yml -t root,install,start"
    - echo "   ansible-playbook -i inventories/inventory.ini playbooks/crxui.yml -t root,install"
    - echo "   ansible-playbook -i inventories/inventory.ini post_install_corax.yaml"
    - echo "==========================================="

  tags:
    - docker

  only:
    - branches

  when: manual  # Требует ручного подтверждения для безопасности
